name: Deploy to HuggingFace Spaces

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/deploy_hf.yml"

jobs:
  test:
    name: Run Backend Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: backend/requirements.txt

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends libgl1 libglib2.0-0

      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu

      - name: Run test suite
        env:
          GEMINI_API_KEY: ""
          MAX_CONCURRENT_JOBS: "2"
        run: |
          pytest backend/tests/ \
            -v \
            --tb=short \
            --junitxml=test-results.xml \
            -p no:warnings

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml
          retention-days: 14

  deploy:
    name: Push backend to HF Spaces
    runs-on: ubuntu-latest
    needs: test  # only runs if tests pass

    steps:
      - name: Checkout repository (with LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Install git-lfs
        run: |
          sudo apt-get install -y git-lfs
          git lfs install

      - name: Configure SSH for HuggingFace
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HF_SSH_KEY }}

      - name: Add hf.co to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan hf.co >> ~/.ssh/known_hosts

      # LFS blob transfers always use HTTPS even when git uses SSH.
      # We configure git credentials so LFS can authenticate for push.
      - name: Configure git credentials for LFS (HTTPS)
        run: |
          git config --global credential.helper store
          echo "https://${{ secrets.HF_USERNAME }}:${{ secrets.HF_TOKEN }}@huggingface.co" >> ~/.git-credentials

      # Clone HF repo but skip downloading LFS blobs — we have our own
      # model files from the checkout above and will push them ourselves.
      - name: Clone HuggingFace Space (skip LFS download)
        env:
          GIT_LFS_SKIP_SMUDGE: "1"
        run: |
          git clone git@hf.co:spaces/navneethdg/BadCoach hf_space
          cd hf_space
          git lfs install

      - name: Sync backend files into HF Space
        run: |
          rsync -av --delete \
            --exclude='.git' \
            --exclude='venv/' \
            --exclude='tests/' \
            --exclude='.env' \
            --exclude='__pycache__/' \
            --exclude='*.pyc' \
            --exclude='._*' \
            --exclude='models/' \
            --exclude='README.md' \
            --exclude='.gitignore' \
            backend/ hf_space/

      - name: Verify model files are LFS-tracked (not raw blobs)
        run: |
          cd hf_space
          git add -A
          echo "--- LFS-tracked files ---"
          git lfs ls-files
          # Fail if any model file is staged as a raw blob instead of LFS pointer
          for f in models/*.pth models/*.pt models/*.task; do
            [ -f "$f" ] || continue
            if ! git lfs ls-files | grep -q "$(basename $f)"; then
              echo "ERROR: $f is NOT tracked by LFS — check .gitattributes"
              exit 1
            fi
          done
          echo "All model files are properly LFS-tracked ✓"

      - name: Commit and push to HuggingFace
        run: |
          cd hf_space
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy."
          else
            git commit -m "Deploy: $(date -u '+%Y-%m-%d %H:%M UTC') — ${{ github.sha }}"
            git push origin main
          fi
